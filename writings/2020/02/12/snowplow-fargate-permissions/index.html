<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" lang="en">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Andrew Hawker">
  <meta name="generator" content="jekyll">
  
  <meta name="dcterms.date" content="2020-02-12 00:50:00 -0800">
  
  
  <meta name="keywords" content="snowplow aws ecs fargate kinesis iam kcl">
  

  <link rel="canonical" href="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />

  
  <title>Snowplow on AWS Fargate - IAM Permissions – Andrew Hawker</title>
  

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/styles/font-awesome.min.css"/>
  <link rel="stylesheet" href="/assets/styles/et-book.min.css">
  <link rel="stylesheet" href="/assets/styles/site.css">
  

  <!--[if lt IE 9]>
  <script src="/assets/js/html5shiv-printshiv.min.js"></script>
  <![endif]-->

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <link rel="manifest" href="/assets/site.webmanifest">

  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-config" content="/assets/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://andrew.hawker.io/feed.xml" title="Andrew Hawker" />

  <!-- Google Analytics -->
  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36365256-1', 'auto');
  ga('send', 'pageview');

</script>

  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Snowplow on AWS Fargate - IAM Permissions | Andrew Hawker</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Snowplow on AWS Fargate - IAM Permissions" />
<meta name="author" content="Andrew Hawker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal website of Andrew Hawker" />
<meta property="og:description" content="Personal website of Andrew Hawker" />
<link rel="canonical" href="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />
<meta property="og:url" content="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />
<meta property="og:site_name" content="Andrew Hawker" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-12T00:50:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Snowplow on AWS Fargate - IAM Permissions" />
<meta name="twitter:site" content="@rekwah" />
<meta name="twitter:creator" content="@rekwah" />
<script type="application/ld+json">
{"url":"https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://andrew.hawker.io/assets/images/android-chrome-512x512.png"},"name":"Andrew Hawker"},"headline":"Snowplow on AWS Fargate - IAM Permissions","dateModified":"2020-02-12T00:50:00-08:00","datePublished":"2020-02-12T00:50:00-08:00","author":{"@type":"Person","name":"Andrew Hawker"},"description":"Personal website of Andrew Hawker","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>




<article>
  

<header>
  <h1 class="title"><a name="Snowplow on AWS Fargate - IAM Permissions"></a>Snowplow on AWS Fargate - IAM Permissions</h1>
  
  
  <p class="byline">February 12, 2020</p>
  
  
  <ul class="tags">
  
    <li class="category"><a href="/archives/category/writings">WRITINGS</a></li>
  
  
    <li class="tag"><a href="/archives/tag/snowplow">SNOWPLOW (4)</a></li>
  
    <li class="tag"><a href="/archives/tag/aws">AWS (5)</a></li>
  
    <li class="tag"><a href="/archives/tag/ecs">ECS (4)</a></li>
  
    <li class="tag"><a href="/archives/tag/fargate">FARGATE (4)</a></li>
  
    <li class="tag"><a href="/archives/tag/kinesis">KINESIS (1)</a></li>
  
    <li class="tag"><a href="/archives/tag/iam">IAM (1)</a></li>
  
    <li class="tag"><a href="/archives/tag/kcl">KCL (1)</a></li>
  
  
  </ul>
</header>



  <hr />
<p>This is part <strong>four</strong> of a blog post series about <strong>Snowplow on AWS Fargate</strong>.</p>
<ul>
<li><a href="/writings/2020/02/09/snowplow-fargate/">Part 1: Snowplow on AWS Fargate</a></li>
<li><a href="/writings/2020/02/10/snowplow-fargate-task-role/">Part 2: Snowplow on AWS Fargate - Task Role</a></li>
<li><a href="/writings/2020/02/11/snowplow-fargate-enricher/">Part 3: Snowplow on AWS Fargate - Stream Enrich</a></li>
</ul>
<hr />
<section id="goal" class="level3">
<h3>Goal</h3>
<p>This post will outline the minimum necessary IAM permissions required to run each Snowplow component in AWS Fargate.</p>
</section>
<section id="investigation" class="level3">
<h3>Investigation</h3>
<p>I spent quite some time investigating this issue before writing this post myself. Questions related to this have been asked a number of times but I was unable to find a <strong>definitive</strong> answer.</p>
<p>The following are related topics/questions I found along the way:</p>
<ul>
<li><strong><a href="https://discourse.snowplowanalytics.com/t/scala-enrich-exception-while-syncing-kinesis-shards-and-leases/2082">[scala] [enrich] exception while sync’ing Kinesis shards and leases</a></strong></li>
<li><strong><a href="https://discourse.snowplowanalytics.com/t/trying-to-set-stream-enrich-with-docker-image-caught-exception-when-initializing-leasecoordinator/2338">Trying to set Stream Enrich with docker image - Caught exception when initializing LeaseCoordinator</a></strong></li>
<li><strong><a href="https://stackoverflow.com/questions/48302878/in-snowplow-is-it-a-compulsory-to-use-dynamodb-in-stream-enrich-process">In Snowplow, is it a compulsory to use DynamoDB in stream enrich process?</a></strong></li>
<li><strong><a href="https://stackoverflow.com/questions/58768658/what-iam-permissions-does-a-kinesis-consumer-need-when-using-kcl">What IAM permissions does a Kinesis Consumer need when using KCL?</a></strong></li>
<li><strong><a href="https://stackoverflow.com/questions/48322207/amazon-kinesis-caught-exception-while-syncing-kinesis-shards-and-leases">Amazon Kinesis: Caught exception while sync’ing Kinesis shards and leases</a></strong></li>
</ul>
<p>The following are error messages you are likely to see when encountering permission issues:</p>
<ul>
<li><code>Caught exception while sync'ing Kinesis shards and leases</code></li>
<li><code>Could not publish</code>n<code>datums to CloudWatch</code></li>
</ul>
<p>The best information I could find previous was “You need to give it create, read write permissions to Dynamo” and “I just gave it full access”. Hopefully this post can do a more thorough job!</p>
</section>
<section id="scala-stream-collector" class="level3">
<h3>Scala Stream Collector</h3>
<p><span><label for="sn-1" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://github.com/snowplow/snowplow/wiki/Scala-stream-collector">technical docs</a> for more details about the scala stream collector.<br />
<br />
</span></span></p>
<p>Collectors in Snowplow are the top of the data funnel. Raw data from the trackers is received over HTTPS and, in the case of streaming deployments, is then written in Thrift to AWS Kinesis data streams. Valid data is written to a “good” stream and invalid data is written to a “bad” stream. In terms of AWS IAM permissions, this one is relatively straight forward.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="fu">{</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="st">&quot;kinesis:PutRecord&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="st">&quot;${collector_stream_out_good}&quot;</span><span class="ot">,</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>        <span class="st">&quot;${collector_stream_out_bad}&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>      <span class="ot">]</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="fu">}</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="ot">]</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="fu">}</span></span></code></pre></div>
</section>
<section id="scala-stream-enricher" class="level3">
<h3>Scala Stream Enricher</h3>
<p><span><label for="sn-2" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://github.com/snowplow/snowplow/wiki/stream-enrich">technical docs</a> for more details about the scala stream enricher.<br />
<br />
</span></span></p>
<p>Enrichers in Snowplow are second in the data funnel and similar to collectors. Raw data is consumed from AWS Kinesis data streams, modified by all configured “enrichers” and then written back out to a AWS Kinesis data stream. Valid data is written to a “good” stream and invalid data is written to a “bad” stream. However, since it uses the AWS Kinesis Client library (KCL), there is more nuance to the IAM permissions required.</p>
<p><span><label for="sn-3" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-3" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://docs.aws.amazon.com/streams/latest/dev/kinesis-record-processor-ddb.html">docs</a> for more details on the DynamoDB state table.<br />
<br />
</span></span></p>
<p>KCL uses an AWS DynamoDB table to manage state of the consumer (leases, checkpoints, etc). This means that our Snowplow enricher also requires all permissions necessary to manage this state table.</p>
<p>KCL also emits metrics to Cloudwatch, so we’ll need permissions for that as well.</p>
<p><span><label for="sn-4" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-4" class="margin-toggle"/><span class="marginnote"> Please note that this example is <strong>not</strong> include a stream for PII data. If you want that, you’ll need to include it in the 3rd statement where write permissions to Kinesis data streams are defined.<br />
<br />
</span></span></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="fu">{</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="st">&quot;kinesis:GetShardIterator&quot;</span><span class="ot">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>        <span class="st">&quot;kinesis:GetRecords&quot;</span><span class="ot">,</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>        <span class="st">&quot;kinesis:ListShards&quot;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>        <span class="st">&quot;${collector_stream_out_good}&quot;</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>      <span class="ot">]</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="fu">{</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>          <span class="st">&quot;kinesis:ListStreams&quot;</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="fu">{</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>        <span class="st">&quot;kinesis:PutRecord&quot;</span><span class="ot">,</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>        <span class="st">&quot;kinesis:PutRecords&quot;</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>        <span class="st">&quot;${enricher_stream_out_good}&quot;</span><span class="ot">,</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>        <span class="st">&quot;${enricher_stream_out_bad}&quot;</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>      <span class="ot">]</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>    <span class="fu">{</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>        <span class="st">&quot;dynamodb:CreateTable&quot;</span><span class="ot">,</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>        <span class="st">&quot;dynamodb:DescribeTable&quot;</span><span class="ot">,</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>        <span class="st">&quot;dynamodb:Scan&quot;</span><span class="ot">,</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>        <span class="st">&quot;dynamodb:GetItem&quot;</span><span class="ot">,</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>        <span class="st">&quot;dynamodb:PutItem&quot;</span><span class="ot">,</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>        <span class="st">&quot;dynamodb:UpdateItem&quot;</span><span class="ot">,</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>        <span class="st">&quot;dynamodb:DeleteItem&quot;</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>        <span class="st">&quot;${enricher_state_table}&quot;</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>      <span class="ot">]</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>    <span class="fu">{</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>        <span class="st">&quot;cloudwatch:PutMetricData&quot;</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb2-56"><a href="#cb2-56"></a>    <span class="fu">}</span></span>
<span id="cb2-57"><a href="#cb2-57"></a>  <span class="ot">]</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="fu">}</span></span></code></pre></div>
</section>
<section id="s3-loader" class="level3">
<h3>S3 Loader</h3>
<p><span><label for="sn-5" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-5" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://github.com/snowplow/snowplow/wiki/snowplow-s3-loader-setup">technical docs</a> for more details about the s3 loader.<br />
<br />
</span></span></p>
<p>Loaders in Snowplow are third in the data funnel and similar to enrichers. Raw data is consumed from AWS Kinesis data streams and written to a valid data sink, in this case, S3. If records can not be written to the sink, they’re written to a “bad” stream. Similar to the enricher, AWS Kinesis Client library (KCL), is also used.</p>
<p><span><label for="sn-6" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-6" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://docs.aws.amazon.com/streams/latest/dev/kinesis-record-processor-ddb.html">docs</a> for more details on the DynamoDB state table.<br />
<br />
</span></span></p>
<p>KCL uses an AWS DynamoDB table to manage state of the consumer (leases, checkpoints, etc). This means that our Snowplow loader also requires all permissions necessary to manage this state table.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="fu">{</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>        <span class="st">&quot;kinesis:GetShardIterator&quot;</span><span class="ot">,</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>        <span class="st">&quot;kinesis:GetRecords&quot;</span><span class="ot">,</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>        <span class="st">&quot;kinesis:ListShards&quot;</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>        <span class="st">&quot;${enricher_stream_out_good}&quot;</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>      <span class="ot">]</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="fu">{</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>          <span class="st">&quot;kinesis:ListStreams&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>          <span class="st">&quot;*&quot;</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>      <span class="ot">]</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="fu">{</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-28"><a href="#cb3-28"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>        <span class="st">&quot;kinesis:PutRecord&quot;</span><span class="ot">,</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>        <span class="st">&quot;kinesis:PutRecords&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>        <span class="st">&quot;${loader_stream_out_bad}&quot;</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>      <span class="ot">]</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>    <span class="fu">{</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>        <span class="st">&quot;dynamodb:CreateTable&quot;</span><span class="ot">,</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>        <span class="st">&quot;dynamodb:DescribeTable&quot;</span><span class="ot">,</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>        <span class="st">&quot;dynamodb:Scan&quot;</span><span class="ot">,</span></span>
<span id="cb3-42"><a href="#cb3-42"></a>        <span class="st">&quot;dynamodb:GetItem&quot;</span><span class="ot">,</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>        <span class="st">&quot;dynamodb:PutItem&quot;</span><span class="ot">,</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>        <span class="st">&quot;dynamodb:UpdateItem&quot;</span><span class="ot">,</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>        <span class="st">&quot;dynamodb:DeleteItem&quot;</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>        <span class="st">&quot;${s3_loader_state_table}&quot;</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>      <span class="ot">]</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-51"><a href="#cb3-51"></a>    <span class="fu">{</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>        <span class="st">&quot;cloudwatch:PutMetricData&quot;</span></span>
<span id="cb3-55"><a href="#cb3-55"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-56"><a href="#cb3-56"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-58"><a href="#cb3-58"></a>    <span class="fu">{</span></span>
<span id="cb3-59"><a href="#cb3-59"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>        <span class="st">&quot;s3:ListBucket&quot;</span></span>
<span id="cb3-62"><a href="#cb3-62"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-64"><a href="#cb3-64"></a>        <span class="st">&quot;arn:aws:s3:::${bucket_id}&quot;</span></span>
<span id="cb3-65"><a href="#cb3-65"></a>      <span class="ot">]</span></span>
<span id="cb3-66"><a href="#cb3-66"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-67"><a href="#cb3-67"></a>    <span class="fu">{</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb3-69"><a href="#cb3-69"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-70"><a href="#cb3-70"></a>        <span class="st">&quot;s3:PutObject&quot;</span></span>
<span id="cb3-71"><a href="#cb3-71"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-72"><a href="#cb3-72"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-73"><a href="#cb3-73"></a>        <span class="st">&quot;arn:aws:s3:::${bucket_id}/*&quot;</span></span>
<span id="cb3-74"><a href="#cb3-74"></a>      <span class="ot">]</span></span>
<span id="cb3-75"><a href="#cb3-75"></a>    <span class="fu">}</span></span>
<span id="cb3-76"><a href="#cb3-76"></a>  <span class="ot">]</span></span>
<span id="cb3-77"><a href="#cb3-77"></a><span class="fu">}</span></span></code></pre></div>
</section>
<section id="elasticsearch-loader" class="level3">
<h3>Elasticsearch Loader</h3>
<p><span><label for="sn-7" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-7" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://github.com/snowplow/snowplow/wiki/elasticsearch-loader-setup">technical docs</a> for more details about the es loader.<br />
<br />
</span></span></p>
<p>The ES loader and S3 loaders are nearly identical, expect we trade an S3 bucket sink for an Elasticsearch cluster.</p>
<p><span><label for="sn-8" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-8" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://docs.aws.amazon.com/streams/latest/dev/kinesis-record-processor-ddb.html">docs</a> for more details on the DynamoDB state table.<br />
<br />
</span></span></p>
<p>KCL uses an AWS DynamoDB table to manage state of the consumer (leases, checkpoints, etc). This means that our Snowplow loader also requires all permissions necessary to manage this state table.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="fu">{</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="st">&quot;kinesis:GetShardIterator&quot;</span><span class="ot">,</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>        <span class="st">&quot;kinesis:GetRecords&quot;</span><span class="ot">,</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>        <span class="st">&quot;kinesis:ListShards&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="st">&quot;${enricher_stream_out_good}&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>      <span class="ot">]</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="fu">{</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>          <span class="st">&quot;kinesis:ListStreams&quot;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>          <span class="st">&quot;*&quot;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>      <span class="ot">]</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>    <span class="fu">{</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>        <span class="st">&quot;kinesis:DescribeStream&quot;</span><span class="ot">,</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>        <span class="st">&quot;kinesis:PutRecord&quot;</span><span class="ot">,</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>        <span class="st">&quot;kinesis:PutRecords&quot;</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>        <span class="st">&quot;${loader_stream_out_bad}&quot;</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>      <span class="ot">]</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="fu">{</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb4-38"><a href="#cb4-38"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>        <span class="st">&quot;dynamodb:CreateTable&quot;</span><span class="ot">,</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>        <span class="st">&quot;dynamodb:DescribeTable&quot;</span><span class="ot">,</span></span>
<span id="cb4-41"><a href="#cb4-41"></a>        <span class="st">&quot;dynamodb:Scan&quot;</span><span class="ot">,</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>        <span class="st">&quot;dynamodb:GetItem&quot;</span><span class="ot">,</span></span>
<span id="cb4-43"><a href="#cb4-43"></a>        <span class="st">&quot;dynamodb:PutItem&quot;</span><span class="ot">,</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>        <span class="st">&quot;dynamodb:UpdateItem&quot;</span><span class="ot">,</span></span>
<span id="cb4-45"><a href="#cb4-45"></a>        <span class="st">&quot;dynamodb:DeleteItem&quot;</span></span>
<span id="cb4-46"><a href="#cb4-46"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-48"><a href="#cb4-48"></a>        <span class="st">&quot;${es_loader_state_table}&quot;</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>      <span class="ot">]</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb4-51"><a href="#cb4-51"></a>    <span class="fu">{</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb4-53"><a href="#cb4-53"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-54"><a href="#cb4-54"></a>        <span class="st">&quot;cloudwatch:PutMetricData&quot;</span></span>
<span id="cb4-55"><a href="#cb4-55"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-56"><a href="#cb4-56"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>    <span class="fu">}</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>  <span class="ot">]</span></span>
<span id="cb4-59"><a href="#cb4-59"></a><span class="fu">}</span></span></code></pre></div>
<p><span><label for="sn-9" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-9" class="margin-toggle"/><span class="marginnote"> Check out the official <a href="https://aws.amazon.com/blogs/security/how-to-control-access-to-your-amazon-elasticsearch-service-domain/">technical docs</a> for more details about AES access policies.<br />
<br />
</span></span></p>
<p>If <a href="https://aws.amazon.com/elasticsearch-service/">Amazon Elasticsearch Service (AES)</a> is being used and you’re running it inside a VPC, you’ll need to make sure the access policies on the domain are also configured. The <strong><code>role</code></strong> here should have a policy attached that grants it all of the permissions that are defined above.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="fu">{</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>      <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>      <span class="dt">&quot;Principal&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>        <span class="dt">&quot;AWS&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>          <span class="st">&quot;${role}&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>        <span class="ot">]</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>      <span class="fu">},</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>      <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>        <span class="st">&quot;es:ES*&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>      <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>        <span class="st">&quot;${domain}&quot;</span><span class="ot">,</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>        <span class="st">&quot;${domain}/*&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>      <span class="ot">]</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="fu">}</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="ot">]</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="fu">}</span></span></code></pre></div>
</section>
<section id="to-be-continued" class="level3">
<h3>To be continued…</h3>
<p>The next blog post in this series will discuss the <a href="https://github.com/snowplow/snowplow/wiki/setting-up-EmrEtlRunner">EmrEtlRunner</a> handling streaming data. Stay tuned!</p>
</section>



<section>
  <p class="return-home"><em><a href="/">Return home</a></em></p>
</section>


</article>






<footer>
    <hr class="footer-hr">
    <ul class="social-links">
      
        <li><a href="https://www.routegy.com" target="_blank" title="Employer"><span class="fa fa-2x fa-building social-icon"></span></a></li>
      
        <li><a href="https://goo.gl/maps/kUBP3GgPGiG2" target="_blank" title="Location"><span class="fa fa-2x fa-map-marker social-icon"></span></a></li>
      
        <li><a href="https://stackoverflow.com/users/84942/ahawker" target="_blank" title="Stack Overflow"><span class="fa fa-2x fa-stack-overflow social-icon"></span></a></li>
      
        <li><a href="https://github.com/ahawker" target="_blank" title="GitHub"><span class="fa fa-2x fa-github-alt social-icon"></span></a></li>
      
        <li><a href="https://linkedin.com/in/ahawker" target="_blank" title="LinkedIn"><span class="fa fa-2x fa-linkedin-square social-icon"></span></a></li>
      
        <li><a href="https://twitter.com/rekwah" target="_blank" title="Twitter"><span class="fa fa-2x fa-twitter social-icon"></span></a></li>
      
        <li><a href="mailto:andrew.r.hawker@gmail.com" target="_blank" title="Email"><span class="fa fa-2x fa-envelope social-icon"></span></a></li>
      
        <li><a href="/feed.xml" target="_blank" title="RSS"><span class="fa fa-2x fa-rss social-icon"></span></a></li>
        
    </ul>
  <div class="credits">
    <span>&copy; 2013 - 2020 &nbsp;&nbsp;ANDREW HAWKER</span></br> <br>
    <span>Code for this website can be found <a href="https://github.com/ahawker/personal-site">here</a>.</span>
  </div>  
</footer>

</body>
</html>

