<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" lang="en">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Andrew Hawker">
  <meta name="generator" content="jekyll">
  
  <meta name="dcterms.date" content="2020-02-12 00:50:00 -0800">
  
  
  <meta name="keywords" content="snowplow aws ecs fargate kinesis iam kcl">
  

  
  <link rel="canonical" href="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />
  

  
  <title>Snowplow on AWS Fargate - IAM Permissions – Andrew Hawker</title>
  

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/styles/font-awesome.min.css"/>
  <link rel="stylesheet" href="/assets/styles/et-book.min.css">
  <link rel="stylesheet" href="/assets/styles/site.css">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <link rel="manifest" href="/assets/site.webmanifest">

  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-config" content="/assets/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://andrew.hawker.io/feed.xml" title="Andrew Hawker" />

  <!-- Google Analytics -->
  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36365256-1', 'auto');
  ga('send', 'pageview');

</script>

  

  <!-- SEO -->
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Snowplow on AWS Fargate - IAM Permissions | Andrew Hawker</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Snowplow on AWS Fargate - IAM Permissions" />
<meta name="author" content="Andrew Hawker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal website of Andrew Hawker" />
<meta property="og:description" content="Personal website of Andrew Hawker" />
<link rel="canonical" href="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />
<meta property="og:url" content="https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/" />
<meta property="og:site_name" content="Andrew Hawker" />
<meta property="og:image" content="https://andrew.hawker.io/assets/images/android-chrome-512x512.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-12T00:50:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://andrew.hawker.io/assets/images/android-chrome-512x512.png" />
<meta property="twitter:title" content="Snowplow on AWS Fargate - IAM Permissions" />
<meta name="twitter:site" content="@rekwah" />
<meta name="twitter:creator" content="@rekwah" />
<script type="application/ld+json">
{"headline":"Snowplow on AWS Fargate - IAM Permissions","dateModified":"2020-02-12T00:50:00-08:00","datePublished":"2020-02-12T00:50:00-08:00","url":"https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrew.hawker.io/writings/2020/02/12/snowplow-fargate-permissions/"},"image":"https://andrew.hawker.io/assets/images/android-chrome-512x512.png","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://andrew.hawker.io/assets/images/android-chrome-512x512.png"},"name":"Andrew Hawker"},"author":{"@type":"Person","name":"Andrew Hawker"},"description":"Personal website of Andrew Hawker","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
<div class="header container-xl px-5 my-5 markdown-body">
  



  
<header>
  
  <h1>
    <a href="/"><img class="title-logo" src="/assets/images/hawk-logo.svg"></a>
    Snowplow on AWS Fargate - IAM Permissions
  </h1>
  
  <div class="col-12">
    
    <p class="h4 color-grey">February 12, 2020</p>
    
  </div>
  <div class="col-12">
    
    <ul class="tags">
    
      <li class="category"><a href="/archives/category/writings">WRITINGS</a></li>
    
    
    
    
      <li class="tag"><a href="/archives/tag/snowplow">SNOWPLOW (4)</a></li>
    
      <li class="tag"><a href="/archives/tag/aws">AWS (7)</a></li>
    
      <li class="tag"><a href="/archives/tag/ecs">ECS (5)</a></li>
    
      <li class="tag"><a href="/archives/tag/fargate">FARGATE (5)</a></li>
    
      <li class="tag"><a href="/archives/tag/kinesis">KINESIS (1)</a></li>
    
      <li class="tag"><a href="/archives/tag/iam">IAM (1)</a></li>
    
      <li class="tag"><a href="/archives/tag/kcl">KCL (1)</a></li>
    
    
    </ul>
  </div>
</header>


</div>
<div class="content container-xl px-5 my-5 markdown-body">
  <hr />

<p>This is part <strong>four</strong> of a blog post series about <strong>Snowplow on AWS Fargate</strong>.</p>

<ul>
  <li><a href="/writings/2020/02/09/snowplow-fargate/">Part 1: Snowplow on AWS Fargate</a></li>
  <li><a href="/writings/2020/02/10/snowplow-fargate-task-role/">Part 2: Snowplow on AWS Fargate - Task Role</a></li>
  <li><a href="/writings/2020/02/11/snowplow-fargate-enricher/">Part 3: Snowplow on AWS Fargate - Stream Enrich</a></li>
</ul>

<hr />

<h3 id="goal">Goal</h3>

<p>This post will outline the minimum necessary IAM permissions required to run each Snowplow component in AWS Fargate.</p>

<h3 id="investigation">Investigation</h3>

<p>I spent quite some time investigating this issue before writing this post myself. Questions related to this have been asked a number of times but I was unable to find a <strong>definitive</strong> answer.</p>

<p>The following are related topics/questions I found along the way:</p>

<ul>
  <li><strong><a href="https://discourse.snowplowanalytics.com/t/scala-enrich-exception-while-syncing-kinesis-shards-and-leases/2082">[scala] [enrich] exception while sync’ing Kinesis shards and leases</a></strong></li>
  <li><strong><a href="https://discourse.snowplowanalytics.com/t/trying-to-set-stream-enrich-with-docker-image-caught-exception-when-initializing-leasecoordinator/2338">Trying to set Stream Enrich with docker image - Caught exception when initializing LeaseCoordinator</a></strong></li>
  <li><strong><a href="https://stackoverflow.com/questions/48302878/in-snowplow-is-it-a-compulsory-to-use-dynamodb-in-stream-enrich-process">In Snowplow, is it a compulsory to use DynamoDB in stream enrich process?</a></strong></li>
  <li><strong><a href="https://stackoverflow.com/questions/58768658/what-iam-permissions-does-a-kinesis-consumer-need-when-using-kcl">What IAM permissions does a Kinesis Consumer need when using KCL?</a></strong></li>
  <li><strong><a href="https://stackoverflow.com/questions/48322207/amazon-kinesis-caught-exception-while-syncing-kinesis-shards-and-leases">Amazon Kinesis: Caught exception while sync’ing Kinesis shards and leases</a></strong></li>
</ul>

<p>The following are error messages you are likely to see when encountering permission issues:</p>

<ul>
  <li><code class="highlighter-rouge">Caught exception while sync'ing Kinesis shards and leases</code></li>
  <li><code class="highlighter-rouge">Could not publish X datums to CloudWatch</code></li>
</ul>

<p>The best information I could find previous was “You need to give it create, read write permissions to Dynamo” and “I just gave it full access”. Hopefully this post can do a more thorough job!</p>

<h3 id="scala-stream-collector">Scala Stream Collector</h3>

<p>Collectors in Snowplow are the top of the data funnel. Raw data from the trackers is received over HTTPS and, in the case of streaming deployments, is then written in Thrift to AWS Kinesis data streams. Valid data is written to a “good” stream and invalid data is written to a “bad” stream. I highly recommend checking out the official <a href="https://github.com/snowplow/snowplow/wiki/Scala-stream-collector">technical docs</a> for more details.</p>

<p>In terms of AWS IAM permissions, this one is relatively straight forward.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecord"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${collector_stream_out_good}"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"${collector_stream_out_bad}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="scala-stream-enricher">Scala Stream Enricher</h3>

<p>Enrichers in Snowplow are second in the data funnel and similar to collectors. Raw data is consumed from AWS Kinesis data streams, modified by all configured “enrichers” and then written back out to a AWS Kinesis data stream.  Valid data is written to a “good” stream and invalid data is written to a “bad” stream. I highly recommend checking out the official <a href="https://github.com/snowplow/snowplow/wiki/stream-enrich">technical docs</a> for more details about the scala stream enricher.</p>

<p>However, since it uses the AWS Kinesis Client library (KCL), there is more nuance to the IAM permissions required.</p>

<p>Per the AWS <a href="https://docs.aws.amazon.com/streams/latest/dev/kinesis-record-processor-ddb.html">docs</a>, KCL uses an AWS DynamoDB table to manage state of the consumer (leases, checkpoints, etc). This means that our Snowplow enricher also requires all permissions necessary to manage this state table.</p>

<p>KCL also emits metrics to Cloudwatch, so we’ll need permissions for that as well.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetShardIterator"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetRecords"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:ListShards"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${collector_stream_out_good}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"kinesis:ListStreams"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecord"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecords"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${enricher_stream_out_good}"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"${enricher_stream_out_bad}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dynamodb:CreateTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DescribeTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:Scan"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:GetItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:PutItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:UpdateItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DeleteItem"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${enricher_state_table}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"cloudwatch:PutMetricData"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Note:</strong>  This example does <strong>not</strong> include a stream for PII data. If you want that, you’ll need to include it in the 3rd statement where write permissions to Kinesis data streams are defined.</p>

<h3 id="s3-loader">S3 Loader</h3>

<p>Loaders in Snowplow are third in the data funnel and similar to enrichers. Raw data is consumed from AWS Kinesis data streams and written to a valid data sink, in this case, S3. If records can not be written to the sink, they’re written to a “bad” stream. I highly recommend checking out the official <a href="https://github.com/snowplow/snowplow/wiki/snowplow-s3-loader-setup">technical docs</a> for more details.</p>

<p>Similar to the enricher, the AWS Kinesis Client library (KCL) is also used, so we will need to include permissions for the DynamoDB state table and Cloudwatch permissions as well.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetShardIterator"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetRecords"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:ListShards"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${enricher_stream_out_good}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"kinesis:ListStreams"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecord"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecords"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${loader_stream_out_bad}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dynamodb:CreateTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DescribeTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:Scan"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:GetItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:PutItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:UpdateItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DeleteItem"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${s3_loader_state_table}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"cloudwatch:PutMetricData"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"s3:ListBucket"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:s3:::${bucket_id}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"s3:PutObject"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:s3:::${bucket_id}/*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<h3 id="elasticsearch-loader">Elasticsearch Loader</h3>

<p>The ES loader and S3 loaders are nearly identical, expect we trade an S3 bucket sink for an Elasticsearch cluster. I highly recommend checking out the official <a href="https://github.com/snowplow/snowplow/wiki/elasticsearch-loader-setup">technical docs</a> for more details about the es loader.</p>

<p>Similar to the enricher and S3 loader, the AWS Kinesis Client library (KCL) is also used, so we will need to include permissions for the DynamoDB state table and Cloudwatch permissions as well.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetShardIterator"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:GetRecords"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:ListShards"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${enricher_stream_out_good}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"kinesis:ListStreams"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"kinesis:DescribeStream"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecord"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kinesis:PutRecords"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${loader_stream_out_bad}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dynamodb:CreateTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DescribeTable"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:Scan"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:GetItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:PutItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:UpdateItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DeleteItem"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${es_loader_state_table}"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"cloudwatch:PutMetricData"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If <a href="https://aws.amazon.com/elasticsearch-service/">Amazon Elasticsearch Service (AES)</a> is being used and you’re running it inside a VPC, you’ll need to make sure the access policies on the domain are also configured. The <strong><code class="highlighter-rouge">role</code></strong> here should have a policy attached that grants it all of the permissions that are defined above. Check out the official <a href="https://aws.amazon.com/blogs/security/how-to-control-access-to-your-amazon-elasticsearch-service-domain/">technical docs</a> for more details about AES access policies.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"${role}"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"es:ES*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"${domain}"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"${domain}/*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<h3 id="to-be-continued">To be continued…</h3>

<p>The next blog post in this series will discuss the <a href="https://github.com/snowplow/snowplow/wiki/setting-up-EmrEtlRunner">EmrEtlRunner</a> handling streaming data. Stay tuned!</p>



<section>
  <p class="return-home"><em><a href="/">Return home</a></em></p>
</section>


</div>
<div class="footer container-xl px-5 my-5">
  



  <footer>
    <hr class="footer-hr">
    <ul class="social-links">
      
        <li><a href="https://www.routegy.com" target="_blank" title="Employer"><span class="fa fa-2x fa-building social-icon"></span></a></li>
      
        <li><a href="https://goo.gl/maps/kUBP3GgPGiG2" target="_blank" title="Location"><span class="fa fa-2x fa-map-marker social-icon"></span></a></li>
      
        <li><a href="https://stackoverflow.com/users/84942/ahawker" target="_blank" title="Stack Overflow"><span class="fa fa-2x fa-stack-overflow social-icon"></span></a></li>
      
        <li><a href="https://github.com/ahawker" target="_blank" title="GitHub"><span class="fa fa-2x fa-github-alt social-icon"></span></a></li>
      
        <li><a href="https://linkedin.com/in/ahawker" target="_blank" title="LinkedIn"><span class="fa fa-2x fa-linkedin-square social-icon"></span></a></li>
      
        <li><a href="https://twitter.com/rekwah" target="_blank" title="Twitter"><span class="fa fa-2x fa-twitter social-icon"></span></a></li>
      
        <li><a href="mailto:andrew.r.hawker@gmail.com" target="_blank" title="Email"><span class="fa fa-2x fa-envelope social-icon"></span></a></li>
      
        <li><a href="/feed.xml" target="_blank" title="RSS"><span class="fa fa-2x fa-rss social-icon"></span></a></li>
      
        <li><a href="/assets/resume.pdf" target="_blank" title="Resume"><span class="fa fa-2x fa-file social-icon"></span></a></li>
        
    </ul>
  <div class="credits">
    <span>&copy; 2013 - 2020 &nbsp;&nbsp;ANDREW HAWKER</span></br> <br>
    <span>Code for this website can be found <a href="https://github.com/ahawker/personal-site">here</a>.</span>
  </div>  
</footer>

</div>
</body>
</html>

